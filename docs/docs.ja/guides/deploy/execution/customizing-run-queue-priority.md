---
title: '実行キューの優先順位のカスタマイズ'
sidebar_position: 400
---

同時実行設定を使用して、Dagster インスタンスのカスタム優先順位付けルールを定義できます。

このガイドを完了すると、以下の内容を理解できるようになります。

- 同時実行の仕組みを理解する
- カスタム優先順位付けルールを定義する方法を学ぶ
- 優先順位付けルールと同時実行制限の連携の仕組みを理解する

## 実行キューについて

実行キューは、実行を待機している一連の Dagster 実行です。
Dagster はキューから実行を取得し、送信された実行に対して `launch_run` を呼び出します。
これは先入先出の優先度キューとして動作します。

例えば、3 つの実行が次の順序で送信された場合:

1. 実行 `A`
2. 実行 `B`
3. 実行 `C`

この場合、実行は同じ順序で起動されます: 実行 `A`、次に `B`、次に `C`。
[プールまたは実行タグの同時実行制限](/guides/operate/managing-concurrency)が設定されていない限り、これは当てはまります。
起動順序は、優先順位付けルールを使用してカスタマイズすることもできます。これについては、このガイドの後半で説明します。

デフォルトでは、すべての実行の優先度は `0` です。
Dagster は優先度の高い実行を最初に起動します。
複数の実行が同じ優先度を持つ場合、Dagster はキューに送信された順に実行を開始します。

負の優先度も許可されており、バックフィルなどの実行セットの優先度を下げるのに役立ちます。

## キューの優先順位付けルールの定義

カスタム優先順位は、`dagster/priority` タグを使用して指定します。このタグは、定義のコード内、または Dagster UI の Launchpad で設定できます。

優先順位の値を定義する際は、以下の点に注意してください。

- 値は文字列として指定された整数である必要があります。例: `"1"`
- 負の値も使用できます。例: `"-1"`

<Tabs>
<TabItem value="In Python" label="Python で">

**Python で**

この例では、優先度は `-1` に設定され、`dagster/priority` タグの値は `"-1"` になっています。

<CodeExample
  startAfter="start_marker_priority"
  endBefore="end_marker_priority"
  path="docs_snippets/docs_snippets/deploying/concurrency_limits/concurrency_limits.py"
/>

</TabItem>
<TabItem value="In the Dagster UI" label="Dagster UI で">

**Dagster UI で**

Dagster UIのLaunchpadを使用すると、優先度タグの値を上書きすることもできます。この例では、**Edit tags** ボタンをクリックして、次のモーダルを表示しました。

![Add tags to run modal in Dagster UI Launchpad](/images/guides/deploy/execution/dagster-priority-in-launchpad.png)

</TabItem>
</Tabs>

**優先順位付けルールと同時実行制限について**

タグ同時実行制限や優先順位付けルールが設定されていない限り、キューに入れられた実行はキューに送信された順に実行されます。
ただし、タグ同時実行制限によってブロックされた実行は、その後に送信された実行をブロックしません。

例を挙げて説明しましょう。
この例では、3 つの実行が次の順序で送信されます。

1. `team: docs` タグが付けられた `A` を実行
2. `team: docs` タグが付けられた `B` を実行
3. タグが付いていない `C` を実行

制限が設定されていない場合、これらの実行は送信された順序で、つまり `A`、`B`、`C` の順に実行されます。

さらに実行を開始する前に、インスタンスの設定に次の設定を追加しましょう:

```yaml
concurrency:
  runs:
    tag_concurrency_limits:
      - key: 'team'
        limit: 1
```

これで、実行 `A` と `B` は同時に実行できなくなり、実行 `C` には制限がなくなります。
各実行が最低 5 分間実行されると仮定すると、実行の開始順序が変わります。

実行が以前と同じ順序、つまり `A`、`B`、`C` で送信された場合、以下のようになります。

- 実行 `A` が起動します。
- 実行 `B` はスキップされます。実行 `A` が進行中で、`team` タグの同時実行数が `1` に制限されているためです。
- 実行 `C` が起動します。
- 実行 `A` の終了後に実行 `B` が起動します。

まとめると、同時実行制限により、この構成では実行の開始順序が `A`、`C`、`B` に変更されます。
